# Развитие бэкенда YouPub

Документ описывает принципы, дорожную карту и приоритеты развития бэкенда для масштабирования до 1000+ пользователей.

## Принципы разработки

### 1. Чистота кода и современный PHP (8.1–8.3)
- **Строгая типизация**: `declare(strict_types=1)` во всех новых и рефакторимых файлах.
- **Типизированные свойства, параметры и возвращаемые типы** везде, где возможно.
- **final** классы и методы там, где наследование не предусмотрено.
- **Атрибуты PHP 8.1+** (например, для роутинга, валидации) — по мере внедрения.
- **PSR-12** для стиля кода.

### 2. Архитектура
- **Domain → Application → Infrastructure → Presentation**
- Контроллеры — тонкие: парсинг ввода, вызов сервиса/use case, формирование ответа.
- Бизнес-логика — в **сервисах** (Application Services / Use Cases).
- Работа с БД — только через **репозитории** (интерфейс в Domain/Application, реализация в Infrastructure).
- Постепенный переход к **инъекции зависимостей** (контейнер или ручная передача в конструктор) вместо `new X()` внутри классов.

### 3. Безопасность (максимальный приоритет)
- **SQL**: только PDO prepared statements (уже соблюдается в Repository).
- **XSS**: экранирование вывода в представлениях; API отдаёт JSON.
- **CSRF**: токены на формах; API по JWT не требует CSRF для state-changing запросов.
- **Mass Assignment**: в репозиториях — явный список полей при create/update, без передачи всего `$_POST`.
- **Загрузка файлов**: проверка MIME (finfo), размера, белый список расширений, сохранение вне webroot или с запретом выполнения.
- **Пароли**: `password_hash()` / `password_verify()` (уже используется).
- **JWT**: алгоритм HS256, срок жизни, в перспективе — refresh-токены и хранение в БД/Redis для отзыва.
- **Rate limiting**: уже есть на auth и API; сохранять и ужесточать при необходимости.

### 4. Масштабируемость и производительность
- **Очереди**: текущая схема (Cron + PHP workers) — ок для старта; готовность к переходу на Redis/RabbitMQ/Database queue (абстракция Job/Queue interface).
- **Горизонтальное масштабирование**: без локального состояния в воркерах; сессии в БД (уже есть таблица `sessions`); rate limit при росте — перенос в Redis.
- **Кэширование**: метаданные, статистика, частые запросы — через абстракцию Cache (файл/Redis) с TTL.
- **БД**: индексы под частые запросы; при росте — анализ медленных запросов (EXPLAIN, логирование).

### 5. Обработка ошибок и логирование
- **Исключения** для управления ошибками; не возвращать «success: false» из сервисов там, где уместно исключение.
- **Централизованный ErrorHandler**: перехват всех необработанных исключений и ошибок PHP, логирование, единый формат ответа (JSON/HTML).
- **Логгер**: Monolog (или совместимый) с уровнями (debug, info, warning, error, critical) и разделением по каналам/файлам (app, auth, upload, workers).

### 6. Тестирование
- Код, пригодный для unit/integration тестов: зависимости через интерфейсы, минимум глобального состояния.
- PHPUnit для критических частей: Auth, валидация, репозитории (с тестовой БД), сервисы публикации (моки YouTube/Telegram).

---

## Дорожная карта (приоритеты)

### Фаза 1 — Фундамент (текущий фокус)
1. **Строгая типизация и PSR-12** в `core/` и по мере правок в `app/`.
2. **Централизованный ErrorHandler** и базовые исключения (`App\Exception`).
3. **Логирование**: внедрение Monolog, замена `error_log()`/`writeLog()` на логгер с уровнями.
4. **Composer-зависимости**: `monolog/monolog`; опционально `firebase/php-jwt` для JWT (или оставить текущую реализацию с документированием).

### Фаза 2 — Архитектура и безопасность
5. **Интерфейсы репозиториев** (например, `VideoRepositoryInterface`) и внедрение зависимостей в сервисы (конструктор).
6. **JWT**: фиксированный алгоритм в заголовке, настраиваемый TTL, задел под refresh-токены (таблица или Redis).
7. **Валидация ввода**: единый слой (объекты запроса или валидатор) вместо разрозненных проверок в контроллерах.
8. **Rate limit**: при росте — перенос в Redis; единый интерфейс RateLimiter.

### Фаза 3 — Масштабирование
9. **Очереди**: абстракция Job/Queue (интерфейс), реализация «database queue» или Redis для публикаций и тяжёлых задач.
10. **Кэш**: абстракция Cache (File/Redis), кэш статистики и метаданных.
11. **Облачное хранилище**: интерфейс Storage (локальный диск + S3/DO Spaces), конфигурируемый драйвер.

### Фаза 4 — Функциональность
12. **Несколько аккаунтов YouTube/Telegram** на пользователя (уже частично есть интеграции; унификация и UI).
13. **Refresh-токены и долгоживущие сессии** (таблица refresh_tokens, ротация).
14. **Асинхронная загрузка больших видео** (chunked upload, фоновый импорт).
15. **Webhook’и** от YouTube/Telegram для событий и статистики.

### Фаза 5 — Дальше
16. Статистика в реальном времени (WebSocket/polling).
17. Shorts/Reels/TikTok.
18. Мультиязычность и мульти-валютность.

---

## Рекомендуемые Composer-пакеты

| Пакет | Назначение |
|-------|------------|
| `monolog/monolog` | Логирование с уровнями и ротацией |
| `firebase/php-jwt` | JWT encode/decode с проверкой алгоритма (опционально) |
| `guzzlehttp/guzzle` | HTTP-клиент для API YouTube/Telegram (при рефакторинге) |
| `league/oauth2-google` | OAuth2 для Google/YouTube (при рефакторинге) |
| `symfony/var-dumper` | Удобный dump в dev (dev-зависимость) |

---

## Структура исключений (предлагаемая)

```
App\Exception\
  AppException (base, implements Throwable)
  ValidationException (400)
  UnauthorizedException (401)
  ForbiddenException (403)
  NotFoundException (404)
  ConflictException (409)
```

ErrorHandler ловит все необработанные исключения, логирует через Monolog и отдаёт JSON (API) или HTML (web) с нужным HTTP-кодом.

---

## Контакты и обновления

При значительных архитектурных изменениях этот документ обновляется. Для вопросов по бэкенду — см. README (поддержка).
